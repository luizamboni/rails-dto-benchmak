# Registration API

Rails API app with Sorbet type checking and Tapioca-generated RBIs.

## Requirements

- Ruby 3.3.x (see `.ruby-version`)
- Bundler
- PostgreSQL

## Setup

```bash
bundle install
```

## Database

```bash
bin/rails db:create db:migrate
```

## Sorbet (type checking)

Sorbet is initialized in `sorbet/` and gem RBIs are generated by Tapioca.

### Regenerate gem RBIs

```bash
bin/tapioca gem
```

### Generate DSL RBIs (optional)

```bash
bin/tapioca dsl
```

### Typecheck

```bash
bundle exec srb tc
```

## Notes

- Sorbet is pinned to a 0.5.x release and Zeitwerk is pinned to 2.6.12 in `Gemfile`
  to keep Tapioca compatible. If you upgrade Rails, Sorbet, or Zeitwerk, re-run:
  `bin/tapioca gem` and then `bundle exec srb tc`.

## Reports

- [V1 vs V2 Performance Report](reports/perf_v1_v2.md)
- [Perf Matrix Report (2026-01-28 22:39:02)](reports/perf_matrix_20260128-223902.md)
- [Perf Summary (Aggregated)](reports/perf_summary_20260128-225501.md)

## Performance test methodology

We benchmark v1 vs v2 using `wrk` against two separate Rails containers, one
per feature-flagged route set (`REGISTRATION_API_VERSION=v1|v2`). This isolates
runtime state per version while keeping the stack identical. Each run:

- Uses the same request method, headers, and JSON payload.
- Runs a warm-up pass (`WARMUP`, default 5s) to reduce cold-cache effects.
- Executes measured runs sequentially with a cool-down delay (`COOLDOWN`,
  default 2s) to reduce GC carryover and transient noise.
- Alternates run order by default (`ORDER=alternate`) to avoid favoring v1 or v2.
- Targets distinct base URLs/ports (default `BASE_URL_V1` `http://localhost:3001`
  and `BASE_URL_V2` `http://localhost:3002`) with versioned paths
  (`V1_PATH=/api/v1/register`, `V2_PATH=/api/v2/register`).
- Samples memory per container via `docker stats` at a fixed interval
  (`DOCKER_CONTAINER_V1/DOCKER_CONTAINER_V2` or `DOCKER_SERVICE_V1/DOCKER_SERVICE_V2`)
  to record average and peak RSS during each run.

Matrix runs sweep durations, connections, and threads; each variation produces
its own report under `reports/` and an index file that lists all runs.
